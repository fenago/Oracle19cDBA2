### Lab_24_0: Diagnosing Failures

**Objective:**
In this lab, you will learn how to detect and repair database corruption, use the Automatic Diagnostic Repository (ADR), analyze instance recovery with ADRCI, and leverage the Data Recovery Advisor to address potential issues in an Oracle database.

**Environment:**
- **Database**: `CDBLAB`
- **PDBs**: `PDBLAB1`, `PDBLAB2`

### Part 1: Setting Up the Environment

**Step 1: Create a Tablespace and a Table for Corruption Testing**

Before diagnosing failures, let's create a scenario where we can test these features.

1. **Create a tablespace for testing**:
   ```sql
   CREATE TABLESPACE test_tbs DATAFILE '/u01/app/oracle/oradata/CDBLAB/test_tbs01.dbf' SIZE 10M AUTOEXTEND ON;
   ```

2. **Create a test table in the `HR` schema**:
   ```sql
   CONNECT hr/hr_password@PDBLAB1;
   
   CREATE TABLE test_table (
       id NUMBER PRIMARY KEY,
       data VARCHAR2(100)
   ) TABLESPACE test_tbs;
   
   INSERT INTO test_table VALUES (1, 'Test Data 1');
   INSERT INTO test_table VALUES (2, 'Test Data 2');
   COMMIT;
   ```

### Part 2: Detecting and Repairing Corruption

**Step 1: Introduce Corruption**

Manually corrupt the datafile by using the following command (use with caution in a real environment):
```bash
dd if=/dev/zero of=/u01/app/oracle/oradata/CDBLAB/test_tbs01.dbf bs=1024 count=10 seek=2000 conv=notrunc
```

**Step 2: Use DBMS_REPAIR to Detect Corruption**

1. **Detect corruption in the `test_table`:**
   ```sql
   BEGIN
       DBMS_REPAIR.CHECK_OBJECT(
           SCHEMA_NAME => 'HR',
           OBJECT_NAME => 'TEST_TABLE',
           REPAIR_TABLE_NAME => 'REPAIR_TABLE'
       );
   END;
   /
   ```

2. **View the detected corruption:**
   ```sql
   SELECT * FROM repair_table;
   ```

**Step 3: Use RMAN to Repair the Corrupted Block**

1. **Connect to RMAN**:
   ```bash
   rman target /
   ```

2. **Repair the corrupted block**:
   ```bash
   BLOCKRECOVER CORRUPTION LIST;
   ```

### Part 3: Using Automatic Diagnostic Repository (ADR)

**Step 1: Set up ADR Base**

1. **Check the current ADR base and home directories**:
   ```sql
   SELECT * FROM V$DIAG_INFO;
   ```

2. **Create a new ADR directory if needed**:
   ```bash
   mkdir -p /u01/app/oracle/diag/rdbms/cdblab/cdblab/
   ```

**Step 2: Use ADRCI to Diagnose Issues**

1. **Start ADRCI**:
   ```bash
   adrci
   ```

2. **Show incidents**:
   ```bash
   ADRCI> show incident
   ```

3. **View alert logs**:
   ```bash
   ADRCI> show alert -tail -f
   ```

### Part 4: Using Data Recovery Advisor

**Step 1: Use RMAN to Advise on Failures**

1. **Connect to RMAN**:
   ```bash
   rman target /
   ```

2. **Check for failures**:
   ```bash
   RMAN> LIST FAILURE;
   ```

3. **Get repair advice**:
   ```bash
   RMAN> ADVISE FAILURE;
   ```

**Step 2: Execute Repairs**

1. **Repair the failure**:
   ```bash
   RMAN> REPAIR FAILURE;
   ```

2. **Change the priority of a failure**:
   ```bash
   RMAN> CHANGE FAILURE 5 PRIORITY LOW;
   ```

### Part 5: Summary and Best Practices

**Recap**: 
In this lab, you learned how to set up and diagnose database issues using various Oracle tools. By creating a scenario with corruption, using ADRCI, RMAN, and Data Recovery Advisor, you can efficiently manage and repair potential failures in your Oracle database environment.

**Skills Acquired:**

- Using RMAN for block-level corruption recovery.
- Navigating the Automatic Diagnostic Repository (ADR).
- Diagnosing and repairing failures using Data Recovery Advisor.
- Understanding how to manage and interpret diagnostic data.

**References**:

- [Oracle RMAN Documentation](https://docs.oracle.com/en/database/oracle/oracle-database/19/bradv/introduction-to-backup-and-recovery.html)
- [Automatic Diagnostic Repository (ADR)](https://docs.oracle.com/en/database/oracle/oracle-database/19/dbseg/diagnostic-repository.html)
- [Data Recovery Advisor](https://docs.oracle.com/en/database/oracle/oracle-database/19/bradv/data-recovery-advisor.html) 

This completes Lab_24_0. Ensure all steps are followed to create the necessary resources for this lab.
