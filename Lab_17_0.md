### Lab_17_0: Analyzing SQL and Optimizing Access Paths

---

**Objective:**

- Learn how to manage optimizer statistics effectively.
- Utilize SQL Tuning Advisor to identify and optimize SQL statements that are resource-intensive.
- Use SQL Access Advisor to tune a workload for improved performance.

**Use Case:**

Imagine you're a DBA managing a busy database that supports multiple critical applications. Over time, as the database grows, you notice that some SQL queries are taking longer to execute, leading to performance bottlenecks. Your task is to identify these poorly performing SQL statements, optimize their execution paths, and ensure that the database runs efficiently.

---

### **Step-by-Step Instructions:**

#### **1. Preparing the Environment**

Before starting, ensure that you have the necessary resources:

1. **Connect to PDBLAB1**:
   - Use SQL Developer or SQL*Plus to connect to `PDBLAB1` as the `SYSTEM` user.

2. **Create Sample Tables and Data**:
   - Create a sample table and insert data to work with:
     ```sql
     CREATE TABLE employees (
         employee_id NUMBER PRIMARY KEY,
         first_name VARCHAR2(50),
         last_name VARCHAR2(50),
         department_id NUMBER,
         salary NUMBER
     );

     INSERT INTO employees VALUES (1, 'John', 'Doe', 10, 50000);
     INSERT INTO employees VALUES (2, 'Jane', 'Smith', 20, 60000);
     INSERT INTO employees VALUES (3, 'Mike', 'Jones', 10, 70000);
     INSERT INTO employees VALUES (4, 'Emily', 'Davis', 30, 80000);
     COMMIT;
     ```

3. **Collect Initial Optimizer Statistics**:
   - Gather statistics for the `employees` table to ensure the optimizer has up-to-date information:
     ```sql
     EXEC DBMS_STATS.GATHER_TABLE_STATS(ownname => 'SYSTEM', tabname => 'EMPLOYEES');
     ```

---

#### **2. Using SQL Tuning Advisor**

SQL Tuning Advisor helps identify and rectify SQL statements that may be underperforming. Follow these steps:

1. **Identify a Query to Tune**:
   - Run a simple query that we will optimize later:
     ```sql
     SELECT * FROM employees WHERE department_id = 10;
     ```

2. **Access SQL Tuning Advisor**:
   - From SQL Developer, navigate to the SQL Tuning Advisor:
     - Go to **Tools** > **SQL Tuning Advisor**.
     - Provide the SQL text and execute it.

3. **Review SQL Tuning Advisor Recommendations**:
   - The SQL Tuning Advisor may recommend creating indexes, rewriting SQL, or collecting statistics.

4. **Implement Recommendations**:
   - If an index is recommended, create it:
     ```sql
     CREATE INDEX idx_dept_id ON employees(department_id);
     ```
   - Re-run the query to observe performance improvements.

---

#### **3. Managing Optimizer Statistics**

Effective management of optimizer statistics is crucial for SQL performance:

1. **Set Optimizer Statistics Preferences**:
   - Set preferences for how statistics are gathered:
     ```sql
     EXEC DBMS_STATS.SET_TABLE_PREFS('SYSTEM', 'EMPLOYEES', 'ESTIMATE_PERCENT', 'DBMS_STATS.AUTO_SAMPLE_SIZE');
     ```

2. **Gather Statistics for the Schema**:
   - Collect statistics for all tables in the schema:
     ```sql
     EXEC DBMS_STATS.GATHER_SCHEMA_STATS('SYSTEM');
     ```

3. **Verify Optimizer Statistics**:
   - Query the DBA views to check the statistics collected:
     ```sql
     SELECT table_name, num_rows, last_analyzed
     FROM dba_tables
     WHERE owner = 'SYSTEM';
     ```

---

#### **4. Using SQL Access Advisor**

SQL Access Advisor helps optimize the physical schema to improve SQL performance.

1. **Access SQL Access Advisor**:
   - Navigate to SQL Access Advisor in SQL Developer:
     - Go to **Tools** > **SQL Access Advisor**.
     - Provide a SQL workload (either manually input SQL or select from historical SQL).

2. **Run SQL Access Advisor**:
   - Execute the advisor and review recommendations, such as creating new indexes or materialized views.

3. **Implement Recommendations**:
   - Create any suggested indexes or materialized views:
     ```sql
     CREATE MATERIALIZED VIEW emp_dept_view AS
     SELECT department_id, COUNT(*)
     FROM employees
     GROUP BY department_id;
     ```

---

### **What to Expect and How to Tune:**

#### **Optimizer Statistics**

- **What to Expect**:
  - Updated and accurate statistics lead to better execution plans.
  - Expect to see improved query performance as the optimizer makes more informed decisions.

- **How to Tune**:
  - Regularly gather schema statistics using `DBMS_STATS`.
  - Use the `AUTO_SAMPLE_SIZE` for balanced performance and accuracy.

#### **SQL Tuning Advisor**

- **What to Expect**:
  - Recommendations such as creating indexes, restructuring SQL, or collecting missing statistics.
  - Execution plans may show reduced cost and improved response times.

- **How to Tune**:
  - Apply recommendations that have the highest potential impact.
  - Avoid unnecessary index creation; consider the impact on DML operations.

#### **SQL Access Advisor**

- **What to Expect**:
  - Recommendations on physical storage enhancements, such as indexes and materialized views.
  - Improved query response times, particularly for complex queries.

- **How to Tune**:
  - Implement recommendations selectively, considering the overall database workload.
  - Re-evaluate access paths periodically as data changes over time.

---

### **Helpful Links**:

- [Oracle Optimizer Statistics: Concepts and Usage](https://docs.oracle.com/en/database/oracle/oracle-database/19/tgsql/optimizer-statistics-concepts.html)
- [SQL Tuning Advisor Documentation](https://docs.oracle.com/en/database/oracle/oracle-database/19/tgsql/sql-tuning-advisor.html)
- [SQL Access Advisor Guide](https://docs.oracle.com/en/database/oracle/oracle-database/19/tgsql/sql-access-advisor.html)

---

**Summary:**

In this lab, you learned how to manage optimizer statistics, use SQL Tuning Advisor to optimize SQL statements, and leverage SQL Access Advisor for improving physical schema design. These tools and techniques are critical for ensuring optimal SQL performance in Oracle databases.
