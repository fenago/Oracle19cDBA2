### Lab_21_0: Creating Database Backups on Oracle 19.3.0

#### Objectives:
- Create whole database backups.
- Create full and incremental backups.
- Configure block change tracking.
- Use Oracle-suggested backup strategy.
- Back up the control file to a trace file.
- Report and manage backups.

#### Environment:
- Database: CDBLAB
- PDBs: PDBLAB1, PDBLAB2

### Part 1: Setting Up the Environment

Before you can begin creating backups, ensure that all necessary resources, directories, and users are created.

#### Step 1: Create Necessary Directories
1. Connect to the server and create directories for backup storage:
    ```bash
    mkdir -p /u01/app/oracle/backups
    mkdir -p /u01/app/oracle/block_change_tracking
    ```
2. Set appropriate permissions for the directories:
    ```bash
    chmod 755 /u01/app/oracle/backups
    chmod 755 /u01/app/oracle/block_change_tracking
    ```

#### Step 2: Prepare the HR Schema in PDBLAB1
1. Connect to PDBLAB1 and create the HR schema:
    ```sql
    CONNECT sys@PDBLAB1 AS SYSDBA;

    -- Create HR user
    CREATE USER hr IDENTIFIED BY hr_password;
    GRANT CONNECT, RESOURCE TO hr;

    -- Create example tables in HR schema
    CONNECT hr/hr_password@PDBLAB1;

    CREATE TABLE employees (
        employee_id NUMBER(6),
        first_name VARCHAR2(20),
        last_name VARCHAR2(25),
        email VARCHAR2(25),
        hire_date DATE,
        job_id VARCHAR2(10),
        salary NUMBER(8,2),
        manager_id NUMBER(6),
        department_id NUMBER(4),
        PRIMARY KEY (employee_id)
    );

    INSERT INTO employees VALUES (100, 'Steven', 'King', 'SKING', SYSDATE, 'AD_PRES', 24000, NULL, 90);
    INSERT INTO employees VALUES (101, 'Neena', 'Kochhar', 'NKOCHHAR', SYSDATE, 'AD_VP', 17000, 100, 90);
    INSERT INTO employees VALUES (102, 'Lex', 'De Haan', 'LDEHAAN', SYSDATE, 'AD_VP', 17000, 100, 90);
    COMMIT;
    ```

2. Verify the HR schema and data:
    ```sql
    SELECT * FROM hr.employees;
    ```

### Part 2: Creating Whole Database Backups

#### Step 1: Connect to RMAN
1. Connect to RMAN:
    ```bash
    rman target /
    ```

#### Step 2: Create a Whole Database Backup
1. Perform a full backup of the entire database:
    ```sql
    BACKUP DATABASE PLUS ARCHIVELOG;
    ```

2. Explanation:
    - The `BACKUP DATABASE PLUS ARCHIVELOG` command creates a backup of the entire database, including all datafiles, control files, and archived redo logs. This ensures that all committed transactions are included in the backup.

### Part 3: Creating Full and Incremental Backups

#### Step 1: Create a Full Backup
1. Create a full backup of specific tablespaces:
    ```sql
    BACKUP TABLESPACE users;
    ```

2. Explanation:
    - This command creates a full backup of the specified tablespaces. In this example, we are backing up the `users` tablespace.

#### Step 2: Create an Incremental Backup
1. Create an incremental level 1 backup:
    ```sql
    BACKUP INCREMENTAL LEVEL 1 DATABASE;
    ```

2. Explanation:
    - Incremental backups capture only the changes made since the last backup. Level 1 backups include all changes made since the last level 0 or level 1 backup.

### Part 4: Configuring Block Change Tracking

1. Enable Block Change Tracking:
    ```sql
    ALTER DATABASE ENABLE BLOCK CHANGE TRACKING USING FILE '/u01/app/oracle/block_change_tracking/rman_change_track.f';
    ```

2. Explanation:
    - Block Change Tracking improves the performance of incremental backups by keeping track of changed blocks since the last backup. This feature allows RMAN to skip unchanged blocks during an incremental backup.

### Part 5: Using Oracle-Suggested Backup Strategy

1. Use Oracleâ€™s suggested backup strategy:
    ```sql
    CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;
    BACKUP DATABASE PLUS ARCHIVELOG;
    ```

2. Explanation:
    - Oracle's suggested backup strategy helps ensure that you have enough backups to restore the database to any point in time within the specified recovery window (7 days in this example).

### Part 6: Backing Up the Control File to a Trace File

1. Back up the control file to a trace file:
    ```sql
    ALTER DATABASE BACKUP CONTROLFILE TO TRACE;
    ```

2. Explanation:
    - This command creates a trace file containing SQL statements that can be used to recreate the control file. This is useful for recovering from control file corruption or loss.

### Part 7: Reporting and Managing Backups

1. List all backups:
    ```sql
    LIST BACKUP;
    ```

2. Report the need for backups:
    ```sql
    REPORT NEED BACKUP;
    ```

3. Delete obsolete backups:
    ```sql
    DELETE OBSOLETE;
    ```

4. Explanation:
    - These commands allow you to manage and report on backups, ensuring that your backup strategy is effective and that storage space is being used efficiently.

### Summary:
In this lab, you learned how to create whole database backups, full and incremental backups, and configure essential backup features like block change tracking. You also explored Oracle's suggested backup strategy, backed up the control file to a trace file, and managed backups using RMAN commands. 

These skills are crucial for ensuring that your Oracle database can be restored and recovered quickly in the event of a failure, minimizing downtime and data loss.

### References:
- [Oracle RMAN Documentation](https://docs.oracle.com/en/database/oracle/oracle-database/19/bradv/oracle-recovery-manager-overview.html)
- [Block Change Tracking Configuration](https://docs.oracle.com/en/database/oracle/oracle-database/19/bradv/block-change-tracking.html)
- [Oracle Suggested Backup Strategy](https://docs.oracle.com/en/database/oracle/oracle-database/19/bradv/backup-strategies.html)

---

This lab provides detailed steps, explanations, and references to help students understand and perform essential database backup operations using RMAN.
